# æµ‹è¯•è®¡åˆ’æ–‡æ¡£ï¼ˆTPDï¼‰

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **åˆ›å»ºæ—¥æœŸ**: YYYY-MM-DD
> **æ–‡æ¡£ç±»å‹**: æµ‹è¯•è®¡åˆ’
> **çŠ¶æ€**: ğŸ“‹ å¾…è¯„å®¡

---

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

### æ–‡æ¡£ç›®çš„

æœ¬æ–‡æ¡£å®šä¹‰ LiteKV é¡¹ç›®çš„æµ‹è¯•ç­–ç•¥ã€æµ‹è¯•èŒƒå›´å’Œæµ‹è¯•è®¡åˆ’ã€‚æ‰€æœ‰å¼€å‘æ´»åŠ¨å¿…é¡»éµå¾ªæ­¤æµ‹è¯•è®¡åˆ’ï¼Œä»¥ç¡®ä¿ä»£ç è´¨é‡å’Œç³»ç»Ÿç¨³å®šæ€§ã€‚

### é€‚ç”¨èŒƒå›´

- **é¡¹ç›®**: LiteKV åˆ†å¸ƒå¼ KV å­˜å‚¨ç³»ç»Ÿ
- **æµ‹è¯•ç±»å‹**: å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€æ€§èƒ½æµ‹è¯•ã€å‹åŠ›æµ‹è¯•
- **é€‚ç”¨äººå‘˜**: ğŸ¤– AI å¼€å‘å·¥ç¨‹å¸ˆã€ğŸ‘¤ æ¶æ„å¸ˆï¼ˆè¯„å®¡æ‰¹å‡†ï¼‰

---

## 1. æµ‹è¯•ç­–ç•¥

### 1.1 æµ‹è¯•é‡‘å­—å¡”

```
        /\
       /E2E\        å°‘é‡ç«¯åˆ°ç«¯æµ‹è¯•
      /------\
     / é›†æˆæµ‹è¯• \     é€‚é‡é›†æˆæµ‹è¯•
    /----------\
   /  å•å…ƒæµ‹è¯•   \    å¤§é‡å•å…ƒæµ‹è¯•
  /--------------\
```

### 1.2 æµ‹è¯•ç±»å‹

| æµ‹è¯•ç±»å‹ | ç›®æ ‡è¦†ç›–ç‡ | è´£ä»»æ–¹ | å·¥å…· |
|----------|-----------|--------|------|
| **å•å…ƒæµ‹è¯•** | â‰¥ 80% | å¼€å‘å·¥ç¨‹å¸ˆ | cargo test |
| **é›†æˆæµ‹è¯•** | æ ¸å¿ƒæµç¨‹ 100% | å¼€å‘å·¥ç¨‹å¸ˆ | cargo test |
| **æ€§èƒ½æµ‹è¯•** | å…³é”®æ“ä½œ | æµ‹è¯•å·¥ç¨‹å¸ˆ | cargo bench, criterion |
| **å‹åŠ›æµ‹è¯•** | æé™åœºæ™¯ | æµ‹è¯•å·¥ç¨‹å¸ˆ | è‡ªå®šä¹‰å·¥å…· |

---

## 2. æµ‹è¯•èŒƒå›´

### 2.1 åŠŸèƒ½æµ‹è¯•

#### å­˜å‚¨å¼•æ“

| åŠŸèƒ½ | æµ‹è¯•åœºæ™¯ | ä¼˜å…ˆçº§ |
|------|----------|--------|
| **Put æ“ä½œ** | åŸºæœ¬å­˜å‚¨ã€è¦†ç›–ã€æ‰¹é‡ | P0 |
| **Get æ“ä½œ** | å­˜åœ¨çš„é”®ã€ä¸å­˜åœ¨çš„é”®ã€æ‰¹é‡ | P0 |
| **Delete æ“ä½œ** | åˆ é™¤å­˜åœ¨çš„é”®ã€åˆ é™¤ä¸å­˜åœ¨çš„é”® | P0 |
| **Scan æ“ä½œ** | èŒƒå›´æŸ¥è¯¢ã€å‰ç¼€æŸ¥è¯¢ | P1 |
| **TTL æ”¯æŒ** | è®¾ç½®è¿‡æœŸã€è‡ªåŠ¨æ¸…ç† | P1 |

#### ä¸€è‡´æ€§åè®®

| åŠŸèƒ½ | æµ‹è¯•åœºæ™¯ | ä¼˜å…ˆçº§ |
|------|----------|--------|
| **Quorum è¯»å†™** | å¤šå‰¯æœ¬ä¸€è‡´æ€§ | P0 |
| **Leader é€‰ä¸¾** | æ•…éšœè½¬ç§» | P0 |
| **æ—¥å¿—å¤åˆ¶** | WAL æŒä¹…åŒ– | P0 |
| **å¿«ç…§** | å®šæœŸå¿«ç…§ã€æ¢å¤ | P1 |

#### ç½‘ç»œå±‚

| åŠŸèƒ½ | æµ‹è¯•åœºæ™¯ | ä¼˜å…ˆçº§ |
|------|----------|--------|
| **RPC é€šä¿¡** | åŸºæœ¬è¯·æ±‚å“åº” | P0 |
| **æ¶ˆæ¯ç¼–è§£ç ** | MessagePack åºåˆ—åŒ– | P0 |
| **è¿æ¥ç®¡ç†** | è¿æ¥æ± ã€é‡è¿ | P1 |
| **è¶…æ—¶å¤„ç†** | è¯·æ±‚è¶…æ—¶ã€é‡è¯• | P1 |

### 2.2 éåŠŸèƒ½æµ‹è¯•

#### æ€§èƒ½æµ‹è¯•

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹è¯•æ–¹æ³• |
|------|--------|----------|
| **ååé‡** | > 100K ops/sec | å‹åŠ›æµ‹è¯• |
| **å»¶è¿Ÿ** | P99 < 10ms | å»¶è¿Ÿæµ‹è¯• |
| **å†…å­˜ä½¿ç”¨** | < 1GB (10K é”®å€¼å¯¹) | èµ„æºç›‘æ§ |

#### å¯é æ€§æµ‹è¯•

| åœºæ™¯ | éªŒè¯å†…å®¹ | ä¼˜å…ˆçº§ |
|------|----------|--------|
| **èŠ‚ç‚¹æ•…éšœ** | æ•°æ®ä¸ä¸¢å¤±ã€æœåŠ¡å¯ç”¨ | P0 |
| **ç½‘ç»œåˆ†åŒº** | åˆ†åŒºæ¢å¤åæ•°æ®ä¸€è‡´ | P0 |
| **ç£ç›˜æ•…éšœ** | WAL æ¢å¤ | P0 |
| **è¿›ç¨‹å´©æºƒ** | é‡å¯åæ¢å¤ | P0 |

---

## 3. æµ‹è¯•è®¡åˆ’

### 3.1 å•å…ƒæµ‹è¯•è®¡åˆ’

#### æµ‹è¯•æ¡†æ¶

- **æ¡†æ¶**: å†…ç½® `cargo test`
- **æ–­è¨€åº“**: å†…ç½® `assert!`, `assert_eq!`, `assert_matches!`
- **Mock**: `mockall`, `mockito`

#### æµ‹è¯•ç»„ç»‡

```
src/
â”œâ”€â”€ btree/
â”‚   â”œâ”€â”€ mod.rs
â”‚   â””â”€â”€ tests.rs          # btree æ¨¡å—æµ‹è¯•
â”œâ”€â”€ storage/
â”‚   â”œâ”€â”€ mod.rs
â”‚   â””â”€â”€ tests.rs          # storage æ¨¡å—æµ‹è¯•
â””â”€â”€ lib.rs
    â””â”€â”€ tests/
        â”œâ”€â”€ integration.rs   # é›†æˆæµ‹è¯•
        â””â”€â”€ common.rs        # æµ‹è¯•å·¥å…·
```

#### æµ‹è¯•ç”¨ä¾‹ç¤ºä¾‹

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_new_btree() {
        let tree = BTree::new(3);
        assert_eq!(tree.len(), 0);
    }

    #[test]
    fn test_insert_and_get() {
        let mut tree = BTree::new(3);
        tree.insert("key1", "value1");
        assert_eq!(tree.get("key1"), Some(&"value1"));
    }

    #[test]
    fn test_split_node() {
        let mut node = BTreeNode::new(3);
        // æ’å…¥è¶³å¤Ÿå¤šçš„é”®è§¦å‘åˆ†è£‚
        for i in 0..10 {
            node.insert(format!("key{}", i), format!("value{}", i));
        }
        assert!(node.should_split());
    }
}
```

### 3.2 é›†æˆæµ‹è¯•è®¡åˆ’

#### æµ‹è¯•åœºæ™¯

| åœºæ™¯ | éªŒè¯å†…å®¹ | ä¼˜å…ˆçº§ |
|------|----------|--------|
| **å¯åŠ¨æµç¨‹** | æœåŠ¡æ­£å¸¸å¯åŠ¨ | P0 |
| **åŸºæœ¬ CRUD** | Put/Get/Delete | P0 |
| **æ‰¹é‡æ“ä½œ** | Batch Put/Delete | P1 |
| **æ•…éšœæ¢å¤** | å´©æºƒåæ•°æ®æ¢å¤ | P0 |

#### æµ‹è¯•æ–‡ä»¶

```
tests/
â”œâ”€â”€ common/
â”‚   â””â”€â”€ mod.rs           # æµ‹è¯•å·¥å…·
â”œâ”€â”€ integration/
â”‚   â”œâ”€â”€ basic_crud.rs    # åŸºæœ¬ CRUD æµ‹è¯•
â”‚   â”œâ”€â”€ batch_ops.rs     # æ‰¹é‡æ“ä½œæµ‹è¯•
â”‚   â””â”€â”€ recovery.rs      # æ•…éšœæ¢å¤æµ‹è¯•
â””â”€â”€ e2e/
    â””â”€â”€ full_workflow.rs # ç«¯åˆ°ç«¯æµ‹è¯•
```

### 3.3 æ€§èƒ½æµ‹è¯•è®¡åˆ’

#### åŸºå‡†æµ‹è¯•æ¡†æ¶

- **æ¡†æ¶**: `criterion` (æ¨èçš„ Rust åŸºå‡†æµ‹è¯•æ¡†æ¶)
- **åˆ†æ**: `cargo-flamegraph` (ç«ç„°å›¾)

#### åŸºå‡†æµ‹è¯•ç¤ºä¾‹

```rust
use criterion::{black_box, criterion_group, criterion_main, Criterion};

fn bench_insert(c: &mut Criterion) {
    c.bench_function("insert_1k_items", |b| {
        b.iter(|| {
            let mut tree = BTree::new(3);
            for i in 0..1000 {
                tree.insert(format!("key{}", i), format!("value{}", i));
            }
            black_box(tree);
        });
    });
}

criterion_group!(btree_benches, bench_insert);
criterion_main!(btree_benches);
```

### 3.4 å‹åŠ›æµ‹è¯•è®¡åˆ’

#### æµ‹è¯•å·¥å…·

- **å·¥å…·**: è‡ªå®šä¹‰å‹åŠ›æµ‹è¯•å·¥å…·
- **ç›‘æ§**: `prometheus`, `grafana`

#### æµ‹è¯•åœºæ™¯

| åœºæ™¯ | é…ç½® | éªŒè¯å†…å®¹ |
|------|------|----------|
| **å¹¶å‘å†™å…¥** | 100 çº¿ç¨‹å¹¶å‘å†™å…¥ | ååé‡ã€å»¶è¿Ÿ |
| **å¤§æ•°æ®é‡** | 1M é”®å€¼å¯¹ | å†…å­˜ä½¿ç”¨ã€æ€§èƒ½ |
| **é•¿æ—¶é—´è¿è¡Œ** | è¿è¡Œ 24 å°æ—¶ | å†…å­˜æ³„æ¼ã€ç¨³å®šæ€§ |

---

## 4. æµ‹è¯•æ•°æ®

### 4.1 æµ‹è¯•æ•°æ®ç”Ÿæˆ

```rust
use rand::Rng;

fn generate_random_key(size: usize) -> String {
    let mut rng = rand::thread_rng();
    (0..size)
        .map(|_| {
            let charset = b"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
            charset[rng.gen_range(0..charset.len())] as char
        })
        .collect()
}

fn generate_test_data(count: usize) -> Vec<(String, String)> {
    (0..count)
        .map(|i| (format!("key{}", i), format!("value{}", i)))
        .collect()
}
```

### 4.2 æµ‹è¯•æ•°æ®æ¸…ç†

```rust
#[cfg(test)]
mod tests {
    use super::*;

    // æ¯ä¸ªæµ‹è¯•å‰æ¸…ç†
    fn setup() {
        // æ¸…ç†æµ‹è¯•æ•°æ®
    }

    // æ¯ä¸ªæµ‹è¯•åæ¸…ç†
    fn teardown() {
        // æ¸…ç†æµ‹è¯•æ•°æ®
    }

    #[test]
    fn test_something() {
        let _guard = setup();
        // æµ‹è¯•ä»£ç 
    }
}
```

---

## 5. æµ‹è¯•æ‰§è¡Œ

### 5.1 æœ¬åœ°æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
cargo test

# è¿è¡Œç‰¹å®šæµ‹è¯•
cargo test test_insert

# è¿è¡Œé›†æˆæµ‹è¯•
cargo test --test integration

# æ˜¾ç¤ºæµ‹è¯•è¾“å‡º
cargo test -- --nocapture

# è¿è¡ŒåŸºå‡†æµ‹è¯•
cargo bench
```

### 5.2 CI æµ‹è¯•

GitHub Actions è‡ªåŠ¨æ‰§è¡Œï¼š

```yaml
- name: Run tests
  run: cargo test --all-features

- name: Run clippy
  run: cargo clippy -- -D warnings

- name: Run benchmarks
  run: cargo bench
```

---

## 6. æµ‹è¯•æŠ¥å‘Š

### 6.1 æµ‹è¯•æŠ¥å‘Šæ¨¡æ¿

| æµ‹è¯•ç±»å‹ | é€šè¿‡ | å¤±è´¥ | è·³è¿‡ | è¦†ç›–ç‡ |
|----------|------|------|------|--------|
| å•å…ƒæµ‹è¯• | 120 | 0 | 2 | 85.3% |
| é›†æˆæµ‹è¯• | 45 | 0 | 0 | - |
| æ€§èƒ½æµ‹è¯• | 8 | 0 | 0 | - |

### 6.2 é—®é¢˜è·Ÿè¸ª

| é—®é¢˜ ID | ç±»å‹ | ä¸¥é‡ç¨‹åº¦ | çŠ¶æ€ | è´Ÿè´£äºº |
|--------|------|----------|------|--------|
| BUG-001 | æµ‹è¯•å¤±è´¥ | P0 | ğŸ”´ ä¿®å¤ä¸­ | - |
| BUG-002 | æ€§èƒ½é€€åŒ– | P1 | ğŸŸ¡ å¾…å¤„ç† | - |

---

## 7. è´¨é‡æ ‡å‡†

### 7.1 ä»£ç è¦†ç›–ç‡è¦æ±‚

| æ¨¡å— | æœ€ä½è¦†ç›–ç‡ | ç›®æ ‡è¦†ç›–ç‡ |
|------|-----------|-----------|
| æ ¸å¿ƒæ¨¡å— | 90% | 95% |
| ä¸šåŠ¡é€»è¾‘ | 80% | 90% |
| å·¥å…·å‡½æ•° | 70% | 80% |

### 7.2 æ€§èƒ½æ ‡å‡†

| æ“ä½œ | ç›®æ ‡ P50 | ç›®æ ‡ P99 | æœ€å¤§ P999 |
|------|---------|---------|----------|
| Get | < 1ms | < 5ms | < 50ms |
| Put | < 2ms | < 10ms | < 100ms |
| Delete | < 1ms | < 5ms | < 50ms |

---

## 8. é£é™©ä¸ç¼“è§£

### 8.1 æµ‹è¯•é£é™©

| é£é™© | å½±å“ | å¯èƒ½æ€§ | ç¼“è§£æªæ–½ |
|------|------|--------|----------|
| æµ‹è¯•ç¯å¢ƒä¸ç¨³å®š | æµ‹è¯•å¤±è´¥ | ä¸­ | ä½¿ç”¨ Docker å®¹å™¨åŒ–ç¯å¢ƒ |
| æµ‹è¯•æ•°æ®ä¸å……åˆ† | è¦†ç›–ç‡ä¸è¶³ | ä¸­ | ç”Ÿæˆæ›´å¤šæµ‹è¯•æ•°æ® |
| æ€§èƒ½æµ‹è¯•ä¸å‡†ç¡® | æ€§èƒ½å›å½’ | ä½ | ä½¿ç”¨ä¸“ä¸šæ€§èƒ½æµ‹è¯•å·¥å…· |

### 8.2 è‡ªåŠ¨åŒ–é£é™©

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| CI èµ„æºä¸è¶³ | æµ‹è¯•è¶…æ—¶ | ä½¿ç”¨ GitHub Actions ç¼“å­˜ |
| å‡é˜³æ€§ | é˜»å¡åˆå¹¶ | ä½¿ç”¨é‡è¯•æœºåˆ¶ |

---

## 9. åç»­è®¡åˆ’

### 9.1 çŸ­æœŸè®¡åˆ’ï¼ˆ1-2 å‘¨ï¼‰

- [ ] å®Œæˆæ ¸å¿ƒæ¨¡å—å•å…ƒæµ‹è¯•
- [ ] å»ºç«‹æµ‹è¯•æ•°æ®ç”Ÿæˆå·¥å…·
- [ ] é…ç½® CI/CD æµ‹è¯•æµç¨‹

### 9.2 ä¸­æœŸè®¡åˆ’ï¼ˆ1-2 æœˆï¼‰

- [ ] å»ºç«‹æ€§èƒ½åŸºå‡†
- [ ] å®ç°å‹åŠ›æµ‹è¯•å·¥å…·
- [ ] è¾¾åˆ° 80% ä»£ç è¦†ç›–ç‡

### 9.3 é•¿æœŸè®¡åˆ’ï¼ˆ3-6 æœˆï¼‰

- [ ] å®ç°æ··æ²Œå·¥ç¨‹æµ‹è¯•
- [ ] å»ºç«‹æŒç»­æ€§èƒ½ç›‘æ§
- [ ] è¾¾åˆ° 90% ä»£ç è¦†ç›–ç‡

---

## é™„å½•

### A. æµ‹è¯•å·¥å…·å®‰è£…

```bash
# criterion (åŸºå‡†æµ‹è¯•)
cargo install cargo-criterion

# tarpaulin (è¦†ç›–ç‡)
cargo install cargo-tarpaulin

# flamegraph (ç«ç„°å›¾)
cargo install flamegraph
```

### B. ç›¸å…³æ–‡æ¡£

- `02_development/01_ç¼–ç è§„èŒƒæ–‡æ¡£.md` - ç¼–ç è§„èŒƒ
- `CLAUDE.md` - å¼€å‘æµç¨‹
- `04_test/02_æµ‹è¯•ç”¨ä¾‹æ–‡æ¡£.md` - æµ‹è¯•ç”¨ä¾‹

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: YYYY-MM-DD
**æœ€åæ›´æ–°**: YYYY-MM-DD
**ç»´æŠ¤è€…**: LiteKV å¼€å‘å›¢é˜Ÿ
**çŠ¶æ€**: ğŸ“‹ å¾…è¯„å®¡
